<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Friend Network</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f7faf9;
    }
    .friend-item {
      margin-bottom: 1rem;
      background: #e8f5e9;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .delete-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
      cursor: pointer;
      float: right;
    }
    .delete-btn:hover {
      background: #c62828;
    }
    .connections-list {
      margin-top: 0.5rem;
      padding-left: 1.2rem;
    }
    .connection-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #ffffff;
      border-radius: 6px;
      margin: 4px 0;
      padding: 4px 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .connection-item button {
      background: #ff7043;
      border: none;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .connection-item button:hover {
      background: #e64a19;
    }
    .connection-form {
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .connection-form select, .connection-form button {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #aaa;
      font-size: 0.9rem;
    }
    .connection-form button {
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    .connection-form button:hover {
      background: #388E3C;
    }
  </style>
</head>
<body>
  <header>
    <h1>üå≥ Friend Network</h1>
    <p>Add, connect, and manage your network</p>
  </header>

  <main>
    <section id="friend-form">
      <input type="text" id="name-input" placeholder="Enter name">
      <button id="add-friend">Add Friend</button>
    </section>

    <section id="friend-tree">
      <ul id="tree-root"></ul>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, update, remove, child } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyCRNRlGcGNNT_s6Io1I5KTlzWnAh6SQOaI",
      authDomain: "friendnetwork-862ab.firebaseapp.com",
      databaseURL: "https://friendnetwork-862ab-default-rtdb.firebaseio.com",
      projectId: "friendnetwork-862ab",
      storageBucket: "friendnetwork-862ab.firebasestorage.app",
      messagingSenderId: "63599209189",
      appId: "1:63599209189:web:d319fd76397014f97d820c",
      measurementId: "G-E05JH3NEYY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const nameInput = document.getElementById("name-input");
    const addBtn = document.getElementById("add-friend");
    const treeRoot = document.getElementById("tree-root");

    // --- Add Friend ---
    async function addFriend() {
      const name = nameInput.value.trim();
      if (!name) return alert("Please enter a name.");

      const newRef = push(ref(db, "Friends"));
      await set(newRef, { name, connections: [] });
      alert(`‚úÖ Added "${name}" with ID: ${newRef.key}`);
      nameInput.value = "";
      loadFriends();
    }

    // --- Delete Friend ---
    async function deleteFriendById(id, name) {
      if (!confirm(`Delete "${name}"?`)) return;
      await remove(ref(db, "Friends/" + id));
      await cleanConnections(id);
      loadFriends();
    }

    // --- Clean up connections ---
    async function cleanConnections(deletedId) {
      const dbRef = ref(db);
      const snapshot = await get(child(dbRef, "Friends"));
      if (!snapshot.exists()) return;

      const allFriends = snapshot.val();
      for (const [id, friend] of Object.entries(allFriends)) {
        if (friend.connections?.includes(deletedId)) {
          const updated = friend.connections.filter(c => c !== deletedId);
          await update(ref(db, "Friends/" + id), { connections: updated });
        }
      }
    }

    // --- Delete Connection ---
    async function deleteConnectionBetween(aId, bId) {
      const dbRef = ref(db);
      const snapshot = await get(child(dbRef, "Friends"));
      if (!snapshot.exists()) return;

      const data = snapshot.val();
      const aConnections = new Set(data[aId]?.connections || []);
      const bConnections = new Set(data[bId]?.connections || []);
      aConnections.delete(bId);
      bConnections.delete(aId);

      await update(ref(db, "Friends/" + aId), { connections: [...aConnections] });
      await update(ref(db, "Friends/" + bId), { connections: [...bConnections] });
      loadFriends();
    }

    // --- Add Connection ---
    async function addConnectionBetween(aId, bId) {
      const dbRef = ref(db);
      const snapshot = await get(child(dbRef, "Friends"));
      if (!snapshot.exists()) return alert("No users found.");

      const allFriends = snapshot.val();
      const aConnections = new Set(allFriends[aId]?.connections || []);
      const bConnections = new Set(allFriends[bId]?.connections || []);
      aConnections.add(bId);
      bConnections.add(aId);

      await update(ref(db, "Friends/" + aId), { connections: [...aConnections] });
      await update(ref(db, "Friends/" + bId), { connections: [...bConnections] });
      loadFriends();
    }

    // --- Load Friends ---
    async function loadFriends() {
      const dbRef = ref(db);
      const snapshot = await get(child(dbRef, "Friends"));
      treeRoot.innerHTML = "";

      if (!snapshot.exists()) {
        treeRoot.innerHTML = "<li>No friends yet.</li>";
        return;
      }

      const friends = snapshot.val();

      for (const [id, friend] of Object.entries(friends)) {
        const li = document.createElement("li");
        li.className = "friend-item";

        // Header
        const header = document.createElement("div");
        header.innerHTML = `
          <button class="delete-btn" data-id="${id}" data-name="${friend.name}">üóëÔ∏è</button>
          <strong>${friend.name}</strong><br>
          <small>ID: ${id}</small>
        `;
        li.appendChild(header);

        // Connections list
        const connList = document.createElement("ul");
        connList.className = "connections-list";
        const connections = friend.connections || [];

        if (connections.length > 0) {
          for (const connId of connections) {
            const connItem = document.createElement("li");
            connItem.className = "connection-item";
            const connName = friends[connId]?.name || `(Unknown ID: ${connId})`;

            connItem.innerHTML = `
              <span>${connName}</span>
              <button data-a="${id}" data-b="${connId}">‚ùå</button>
            `;
            connItem.querySelector("button").addEventListener("click", (e) => {
              const a = e.target.getAttribute("data-a");
              const b = e.target.getAttribute("data-b");
              deleteConnectionBetween(a, b);
            });

            connList.appendChild(connItem);
          }
        } else {
          connList.innerHTML = `<li><em>No connections</em></li>`;
        }
        li.appendChild(connList);

        // --- Dropdown to add connections ---
        const availableFriends = Object.entries(friends)
          .filter(([fid]) => fid !== id && !(connections || []).includes(fid));

        if (availableFriends.length > 0) {
          const connForm = document.createElement("div");
          connForm.className = "connection-form";

          const select = document.createElement("select");
          for (const [fid, fdata] of availableFriends) {
            const option = document.createElement("option");
            option.value = fid;
            option.textContent = fdata.name;
            select.appendChild(option);
          }

          const addBtn = document.createElement("button");
          addBtn.textContent = "‚ûï Add Connection";
          addBtn.addEventListener("click", () => {
            const targetId = select.value;
            addConnectionBetween(id, targetId);
          });

          connForm.appendChild(select);
          connForm.appendChild(addBtn);
          li.appendChild(connForm);
        }

        // Delete user button listener
        header.querySelector(".delete-btn").addEventListener("click", (e) => {
          const userId = e.target.getAttribute("data-id");
          const userName = e.target.getAttribute("data-name");
          deleteFriendById(userId, userName);
        });

        treeRoot.appendChild(li);
      }
    }

    addBtn.addEventListener("click", addFriend);
    window.addEventListener("load", loadFriends);
  </script>
</body>
</html>
