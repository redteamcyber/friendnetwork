<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Friend Network</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #0d1117;         /* deep dark background */
    color: #e6edf3;              /* soft white text */
  }

  header {
    text-align: center;
    background: #1e3a8a;         /* deep blue */
    color: #e6edf3;
    padding: 1rem 0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  }

  #login-section {
    text-align: center;
    margin: 1rem 0;
  }

  #login-btn {
    background: #2563eb;         /* blue button */
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
  }
  #login-btn:hover { background: #1e40af; }

  .friend-item {
    margin-bottom: 1rem;
    background: #161b22;          /* GitHub dark gray */
    border: 1px solid #2d3748;    /* border subtle */
    border-radius: 10px;
    padding: 0.75rem 1rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.4);
  }

  .delete-btn {
    background: #dc2626;          /* red */
    color: white;
    border: none;
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    cursor: pointer;
    float: right;
  }
  .delete-btn:hover { background: #b91c1c; }

  .connections-list {
    margin-top: 0.5rem;
    padding-left: 1.2rem;
  }

  .connection-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #1f2937;          /* darker blue-gray */
    border-radius: 6px;
    margin: 4px 0;
    padding: 6px 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.4);
  }

  .connection-item button {
    background: #ad3333;          /* bright blue */
    border: none;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
  }
  .connection-item button:hover { background: #ad3333; }

  .connection-form {
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .connection-form select,
  .connection-form button {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    border: 1px solid #475569;
    font-size: 0.9rem;
    background: #0f172a;          /* deep navy */
    color: #e6edf3;
  }

  .connection-form button {
    background: #2563eb;
    color: white;
    border: none;
    cursor: pointer;
  }
  .connection-form button:hover { background: #1e40af; }
</style>
</head>
<body>
  <header>
    <h1>üå≥ Friend Network</h1>
    <p>Add, connect, and manage your network</p>
    <a href="Connections.html" style="
      display:inline-block;
      margin-top:10px;
      font-size:1rem;
      color:#1976D2;
      text-decoration:none;
      font-weight:bold;
    ">Go to Connections Page</a>
  </header>

  <section id="login-section">
    <button id="login-btn">Login with Google</button>
  </section>

  <main>
    <section id="friend-form">
      <input type="text" id="name-input" placeholder="Enter name" />
      <button id="add-friend">Add Friend</button>
    </section>

    <section id="friend-tree">
      <ul id="tree-root"></ul>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { 
      getDatabase, ref, set, get, push, update, remove, child 
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
    import { 
      getAuth, GoogleAuthProvider, signInWithPopup 
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCRNRlGcGNNT_s6Io1I5KTlzWnAh6SQOaI",
      authDomain: "friendnetwork-862ab.firebaseapp.com",
      databaseURL: "https://friendnetwork-862ab-default-rtdb.firebaseio.com",
      projectId: "friendnetwork-862ab",
      storageBucket: "friendnetwork-862ab.firebasestorage.app",
      messagingSenderId: "63599209189",
      appId: "1:63599209189:web:d319fd76397014f97d820c",
      measurementId: "G-E05JH3NEYY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("login-btn");
    const nameInput = document.getElementById("name-input");
    const addBtn = document.getElementById("add-friend");
    const treeRoot = document.getElementById("tree-root");

    // --- LOGIN AND ADD USER UNDER /Friends/{uid} ---
    loginBtn.addEventListener("click", async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        const userRef = ref(db, "Friends/" + user.uid);
        const snapshot = await get(userRef);

        if (!snapshot.exists()) {
          await set(userRef, {
            name: user.displayName,
            connections: []
          });
          alert(`‚úÖ Added ${user.displayName} to Friends!`);
        } else {
          alert(`üëã Welcome back, ${user.displayName}!`);
        }

        loadFriends();
      } catch (error) {
        console.error("Login failed:", error);
        alert("Login failed: " + error.message);
      }
    });

    // --- ADD FRIEND ---
    async function addFriend() {
      const name = nameInput.value.trim();
      if (!name) return alert("Please enter a name.");
      const newRef = push(ref(db, "Friends"));
      await set(newRef, { name, connections: [] });
      alert(`‚úÖ Added "${name}"`);
      nameInput.value = "";
      loadFriends();
    }

    // --- DELETE FRIEND ---
    async function deleteFriendById(id, name) {
      if (!confirm(`Delete "${name}"?`)) return;
      await remove(ref(db, "Friends/" + id));
      await cleanConnections(id);
      loadFriends();
    }

    // --- CLEAN CONNECTIONS ---
    async function cleanConnections(deletedId) {
      const dbRef = ref(db);
      const snapshot = await get(child(dbRef, "Friends"));
      if (!snapshot.exists()) return;
      const allFriends = snapshot.val();
      for (const [id, friend] of Object.entries(allFriends)) {
        if (friend.connections?.includes(deletedId)) {
          const updated = friend.connections.filter(c => c !== deletedId);
          await update(ref(db, "Friends/" + id), { connections: updated });
        }
      }
    }

    // --- DELETE CONNECTION ---
    async function deleteConnectionBetween(aId, bId) {
      const dbRef = ref(db);
      const snapshot = await get(child(dbRef, "Friends"));
      if (!snapshot.exists()) return;
      const data = snapshot.val();
      const aConnections = new Set(data[aId]?.connections || []);
      const bConnections = new Set(data[bId]?.connections || []);
      aConnections.delete(bId);
      bConnections.delete(aId);
      await update(ref(db, "Friends/" + aId), { connections: [...aConnections] });
      await update(ref(db, "Friends/" + bId), { connections: [...bConnections] });
      loadFriends();
    }

    // --- ADD CONNECTION ---
    async function addConnectionBetween(aId, bId) {
      const dbRef = ref(db);
      const snapshot = await get(child(dbRef, "Friends"));
      if (!snapshot.exists()) return alert("No users found.");
      const allFriends = snapshot.val();
      const aConnections = new Set(allFriends[aId]?.connections || []);
      const bConnections = new Set(allFriends[bId]?.connections || []);
      aConnections.add(bId);
      bConnections.add(aId);
      await update(ref(db, "Friends/" + aId), { connections: [...aConnections] });
      await update(ref(db, "Friends/" + bId), { connections: [...bConnections] });
      loadFriends();
    }

    // --- LOAD FRIENDS ---
    async function loadFriends() {
      const dbRef = ref(db);
      const snapshot = await get(child(dbRef, "Friends"));
      treeRoot.innerHTML = "";
      if (!snapshot.exists()) {
        treeRoot.innerHTML = "<li>No friends yet.</li>";
        return;
      }
      const friends = snapshot.val();
      for (const [id, friend] of Object.entries(friends)) {
        const li = document.createElement("li");
        li.className = "friend-item";
        const header = document.createElement("div");
        header.innerHTML = `
          <button class="delete-btn" data-id="${id}" data-name="${friend.name}">üóëÔ∏è</button>
          <strong>${friend.name}</strong><br>
          <small>ID: ${id}</small>
        `;
        li.appendChild(header);

        const connList = document.createElement("ul");
        connList.className = "connections-list";
        const connections = friend.connections || [];
        if (connections.length > 0) {
          for (const connId of connections) {
            const connItem = document.createElement("li");
            connItem.className = "connection-item";
            const connName = friends[connId]?.name || `(Unknown ID: ${connId})`;
            connItem.innerHTML = `
              <span>${connName}</span>
              <button data-a="${id}" data-b="${connId}">‚ùå</button>
            `;
            connItem.querySelector("button").addEventListener("click", (e) => {
              const a = e.target.getAttribute("data-a");
              const b = e.target.getAttribute("data-b");
              deleteConnectionBetween(a, b);
            });
            connList.appendChild(connItem);
          }
        } else {
          connList.innerHTML = `<li><em>No connections</em></li>`;
        }
        li.appendChild(connList);

        const availableFriends = Object.entries(friends)
          .filter(([fid]) => fid !== id && !(connections || []).includes(fid));
        if (availableFriends.length > 0) {
          const connForm = document.createElement("div");
          connForm.className = "connection-form";
          const select = document.createElement("select");
          for (const [fid, fdata] of availableFriends) {
            const option = document.createElement("option");
            option.value = fid;
            option.textContent = fdata.name;
            select.appendChild(option);
          }
          const addBtn = document.createElement("button");
          addBtn.textContent = "‚ûï Add Connection";
          addBtn.addEventListener("click", () => {
            const targetId = select.value;
            addConnectionBetween(id, targetId);
          });
          connForm.appendChild(select);
          connForm.appendChild(addBtn);
          li.appendChild(connForm);
        }

        header.querySelector(".delete-btn").addEventListener("click", (e) => {
          const userId = e.target.getAttribute("data-id");
          const userName = e.target.getAttribute("data-name");
          deleteFriendById(userId, userName);
        });

        treeRoot.appendChild(li);
      }
    }

    addBtn.addEventListener("click", addFriend);
    window.addEventListener("load", loadFriends);
  </script>
</body>
</html>