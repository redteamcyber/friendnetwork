<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Friend Network</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>🌳 Friend Network</h1>
    <p>Add friends and link them together using unique IDs</p>
  </header>

  <main>
    <section id="friend-form">
      <input type="text" id="name-input" placeholder="Enter name">
      <button id="add-friend">Add Friend</button>
      <button id="delete-friend">Delete Friend (by name)</button>
    </section>

    <section id="connect-form" style="margin-top: 1rem; text-align:center;">
      <input type="text" id="source-id" placeholder="Friend ID (person A)">
      <input type="text" id="target-id" placeholder="Connection ID (person B)">
      <button id="add-connection">Add Connection</button>
    </section>

    <section id="friend-tree">
      <ul id="tree-root"></ul>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, update, remove, child } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyCRNRlGcGNNT_s6Io1I5KTlzWnAh6SQOaI",
      authDomain: "friendnetwork-862ab.firebaseapp.com",
      databaseURL: "https://friendnetwork-862ab-default-rtdb.firebaseio.com",
      projectId: "friendnetwork-862ab",
      storageBucket: "friendnetwork-862ab.firebasestorage.app",
      messagingSenderId: "63599209189",
      appId: "1:63599209189:web:d319fd76397014f97d820c",
      measurementId: "G-E05JH3NEYY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Elements ---
    const nameInput = document.getElementById("name-input");
    const addBtn = document.getElementById("add-friend");
    const deleteBtn = document.getElementById("delete-friend");
    const sourceIdInput = document.getElementById("source-id");
    const targetIdInput = document.getElementById("target-id");
    const connectBtn = document.getElementById("add-connection");
    const treeRoot = document.getElementById("tree-root");

    // --- Add a New Friend ---
    async function addFriend() {
      const name = nameInput.value.trim();
      if (!name) return alert("Please enter a name.");

      try {
        const newRef = push(ref(db, "Friends"));
        await set(newRef, {
          name: name,
          connections: []
        });
        alert(`✅ Friend "${name}" added with ID: ${newRef.key}`);
        nameInput.value = "";
        loadFriends();
      } catch (err) {
        console.error(err);
        alert("Error adding friend.");
      }
    }

    // --- Add Connection by Unique IDs ---
    async function addConnection() {
      const sourceId = sourceIdInput.value.trim();
      const targetId = targetIdInput.value.trim();

      if (!sourceId || !targetId) return alert("Please enter both IDs.");
      if (sourceId === targetId) return alert("Cannot connect a user to themselves.");

      try {
        const dbRef = ref(db);
        const snapshot = await get(child(dbRef, "Friends"));
        if (!snapshot.exists()) return alert("No users found.");

        const allFriends = snapshot.val();

        if (!allFriends[sourceId]) return alert("Source ID not found.");
        if (!allFriends[targetId]) return alert("Target ID not found.");

        const sourceConnections = new Set(allFriends[sourceId].connections || []);
        const targetConnections = new Set(allFriends[targetId].connections || []);

        // Add mutual connections
        sourceConnections.add(targetId);
        targetConnections.add(sourceId);

        await update(ref(db, "Friends/" + sourceId), {
          connections: Array.from(sourceConnections)
        });
        await update(ref(db, "Friends/" + targetId), {
          connections: Array.from(targetConnections)
        });

        alert(`🔗 Connected ${allFriends[sourceId].name} ↔ ${allFriends[targetId].name}`);
        sourceIdInput.value = "";
        targetIdInput.value = "";
        loadFriends();
      } catch (err) {
        console.error(err);
        alert("Error adding connection.");
      }
    }

    // --- Delete Friend by Name ---
    async function deleteFriend() {
      const name = nameInput.value.trim();
      if (!name) return alert("Enter a name to delete.");

      const dbRef = ref(db);
      const snapshot = await get(child(dbRef, "Friends"));
      if (snapshot.exists()) {
        const data = snapshot.val();
        const entry = Object.entries(data).find(([id, f]) => f.name === name);
        if (entry) {
          await remove(ref(db, "Friends/" + entry[0]));
          alert(`🗑️ Deleted "${name}"`);
          loadFriends();
        } else {
          alert("No user found with that name.");
        }
      }
    }

    // --- Load Friends ---
    async function loadFriends() {
      const dbRef = ref(db);
      const snapshot = await get(child(dbRef, "Friends"));
      treeRoot.innerHTML = "";

      if (snapshot.exists()) {
        const friends = snapshot.val();

        for (const [id, friend] of Object.entries(friends)) {
          const li = document.createElement("li");
          const connectedNames = (friend.connections || [])
            .map(cid => friends[cid]?.name || `(Unknown ID: ${cid})`)
            .join(", ") || "None";

          li.innerHTML = `
            <span class="node">${friend.name}</span>
            <br><small>ID: ${id}</small>
            <br>Connections: ${connectedNames}
          `;
          treeRoot.appendChild(li);
        }
      } else {
        treeRoot.innerHTML = "<li>No friends yet.</li>";
      }
    }

    // --- Event Listeners ---
    addBtn.addEventListener("click", addFriend);
    connectBtn.addEventListener("click", addConnection);
    deleteBtn.addEventListener("click", deleteFriend);
    window.addEventListener("load", loadFriends);
  </script>
</body>
</html>
